# Azure DevOps Pipeline for Booking.com Automation Framework
# This pipeline runs the test suite and publishes Allure reports

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - .gitignore

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.11'
  BROWSER: 'chrome'
  HEADLESS: 'true'

stages:
  - stage: Test
    displayName: 'Run Tests'
    jobs:
      - job: RunTests
        displayName: 'Execute Test Suite'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Set Python Version'
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true
          
          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'
          
          - script: |
              # Install Chrome and ChromeDriver dependencies
              sudo apt-get update
              sudo apt-get install -y chromium-browser chromium-chromedriver
            displayName: 'Install Browser Dependencies'
          
          - script: |
              pytest tests/ \
                --browser=$(BROWSER) \
                --headless=$(HEADLESS) \
                --alluredir=reports/allure-results \
                --junitxml=reports/junit/test-results.xml \
                -v \
                -s
            displayName: 'Run Pytest Tests'
            continueOnError: true
          
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'reports/junit/test-results.xml'
              failTaskOnFailedTests: false
              testRunTitle: 'Booking.com Automation Tests'
          
          - script: |
              # Install Allure command line
              wget https://github.com/allure-framework/allure2/releases/download/2.24.1/allure-2.24.1.tgz
              tar -zxvf allure-2.24.1.tgz
              sudo mv allure-2.24.1 /opt/allure
              sudo ln -s /opt/allure/bin/allure /usr/bin/allure
              
              # Generate Allure report
              allure generate reports/allure-results -o reports/allure-report --clean
            displayName: 'Generate Allure Report'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Allure Report'
            inputs:
              PathtoPublish: 'reports/allure-report'
              ArtifactName: 'allure-report'
              publishLocation: 'Container'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Screenshots'
            inputs:
              PathtoPublish: 'screenshots'
              ArtifactName: 'screenshots'
              publishLocation: 'Container'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Logs'
            inputs:
              PathtoPublish: 'logs'
              ArtifactName: 'logs'
              publishLocation: 'Container'
            condition: always()

  - stage: Report
    displayName: 'Test Report Summary'
    dependsOn: Test
    condition: always()
    jobs:
      - job: Summary
        displayName: 'Generate Summary'
        steps:
          - script: |
              echo "Test execution completed"
              echo "Check the published artifacts for detailed reports"
            displayName: 'Test Summary'
